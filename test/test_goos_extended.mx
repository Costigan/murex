#!/usr/bin/env murex

set project=github.com/lmorg/murex

cd $GOPATH/src/$project/test
mkdir build-tests
cd build-tests

set json targets=({
    "linux":     [ "386", "amd64", "arm" ],
    "freebsd":   [ "386", "amd64", "arm" ],
    "openbsd":   [ "386", "amd64", "arm" ],
    "netbsd":    [ "386", "amd64", "arm" ],
    "dragonfly": [        "amd64"        ],
    "darwin":    [ "386", "amd64"        ],
    "solaris":   [        "amd64"        ],
    "plan9":     [ "386", "amd64", "arm" ],
    "windows":   [ "386", "amd64", "arm" ]
})

let status=0

$targets -> formap os cpus {
    $cpus -> foreach arch {
        try {
            ({BLUE}Building $os/$arch....{RESET})
            export GOOS=$os
            export GOARCH=$arch
            go build $project
            out "{GREEN}SUCCESSFUL{RESET}"
        }
        catch {
            out "{RED}FAILED{RESET}"
            let status++
        }
    }
}

cd ..
rm -rf build-tests

exit $status
